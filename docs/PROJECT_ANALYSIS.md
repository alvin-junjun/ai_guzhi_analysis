# 项目架构与功能分析

> 文档版本：v1.0  
> 分析日期：2026-02-04

---

## 目录

- [一、项目概述](#一项目概述)
- [二、系统架构](#二系统架构)
- [三、核心流程](#三核心流程)
- [四、数据库分析](#四数据库分析)
- [五、现有功能清单](#五现有功能清单)
- [六、功能扩展建议](#六功能扩展建议)

---

## 一、项目概述

### 1.1 项目定位

**A股/港股/美股智能分析系统** - 基于 AI 的股票分析工具，提供：

- 个股技术面分析（均线、MACD、RSI、量能）
- 基本面新闻情报搜索
- AI 综合研判（Gemini/OpenAI）
- 多渠道消息推送
- 大盘复盘分析

### 1.2 技术栈

| 层级 | 技术方案 |
|------|----------|
| **运行入口** | `main.py`（命令行）/ `webui.py`（Web服务） |
| **Web框架** | Python 原生 `http.server.ThreadingHTTPServer` |
| **数据库** | **SQLite + SQLAlchemy ORM** |
| **AI分析** | Google Gemini / OpenAI 兼容 API |
| **数据源** | Efinance / Akshare / Tushare / Baostock / YFinance |
| **搜索引擎** | Bocha / Tavily / SerpAPI |
| **消息推送** | 企业微信/飞书/Telegram/Discord/邮件/Pushover 等 |

---

## 二、系统架构

### 2.1 目录结构

```
daily_stock_analysis/
├── main.py                 # 主程序入口（命令行模式）
├── webui.py                # WebUI 入口（向后兼容）
├── analyzer_service.py     # 分析服务（待清理）
│
├── src/                    # 核心业务模块
│   ├── config.py           # 全局配置（单例模式）
│   ├── storage.py          # 数据库管理（SQLite + SQLAlchemy）
│   ├── analyzer.py         # AI 分析器（Gemini/OpenAI）
│   ├── stock_analyzer.py   # 趋势分析器（技术指标）
│   ├── notification.py     # 多渠道通知服务
│   ├── search_service.py   # 新闻搜索服务
│   ├── scheduler.py        # 定时任务调度
│   ├── formatters.py       # 报告格式化
│   ├── enums.py            # 枚举定义
│   ├── feishu_doc.py       # 飞书云文档生成
│   └── core/
│       ├── pipeline.py     # 核心分析流水线
│       └── market_review.py # 大盘复盘模块
│
├── web/                    # WebUI 模块
│   ├── server.py           # HTTP 服务器
│   ├── router.py           # 路由分发
│   ├── handlers.py         # 请求处理器
│   ├── services.py         # 业务服务层
│   └── templates.py        # HTML 模板
│
├── data_provider/          # 数据源策略层
│   ├── base.py             # 基类 + 数据源管理器
│   ├── efinance_fetcher.py # Efinance 数据源
│   ├── akshare_fetcher.py  # Akshare 数据源
│   ├── tushare_fetcher.py  # Tushare 数据源
│   ├── baostock_fetcher.py # Baostock 数据源
│   ├── pytdx_fetcher.py    # 通达信数据源
│   ├── yfinance_fetcher.py # YFinance 数据源
│   └── realtime_types.py   # 实时行情类型定义
│
├── bot/                    # 机器人模块
│   ├── handler.py          # Webhook 处理
│   ├── dispatcher.py       # 命令分发
│   ├── commands/           # 命令实现
│   └── platforms/          # 平台适配（飞书/钉钉/Discord）
│
└── data/                   # 数据目录
    └── stock_analysis.db   # SQLite 数据库文件
```

### 2.2 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户入口                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                │
│  │  main.py     │   │  webui.py    │   │  Bot Webhook │                │
│  │  命令行模式   │   │  Web服务     │   │  机器人交互   │                │
│  └──────┬───────┘   └──────┬───────┘   └──────┬───────┘                │
│         │                  │                  │                         │
└─────────┼──────────────────┼──────────────────┼─────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         核心处理层                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                StockAnalysisPipeline                           │    │
│  │                   核心分析流水线                                 │    │
│  │                                                                │    │
│  │  1. 获取股票数据 (DataFetcherManager)                          │    │
│  │  2. 保存到数据库 (DatabaseManager)                             │    │
│  │  3. 趋势分析 (StockTrendAnalyzer)                              │    │
│  │  4. 新闻搜索 (SearchService)                                   │    │
│  │  5. AI 分析 (GeminiAnalyzer)                                   │    │
│  │  6. 推送通知 (NotificationService)                             │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据/服务层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │ DataFetcherMgr  │  │ DatabaseManager │  │ SearchService   │         │
│  │ 多数据源故障切换 │  │ SQLite + ORM   │  │ 新闻情报搜索    │         │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘         │
│           │                    │                    │                   │
│           ▼                    ▼                    ▼                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │ Efinance/Akshare│  │ stock_daily    │  │ Bocha/Tavily/   │         │
│  │ Tushare/Baostock│  │   (唯一表)     │  │ SerpAPI         │         │
│  │ YFinance/Pytdx  │  │                │  │                 │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         通知推送层                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    NotificationService                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ 企业微信 │ 飞书 │ Telegram │ Discord │ 邮件 │ Pushover │ ...   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心流程

### 3.1 完整分析流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         股票分析完整流程                                  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  用户触发分析                                                             │
│  (命令行 / WebUI / 机器人命令)                                            │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Step 1: 获取股票数据                                             │   │
│  │                                                                  │   │
│  │   DataFetcherManager.get_daily_data(code, days=30)               │   │
│  │        │                                                         │   │
│  │        ├── 尝试 Efinance  ──→ 失败 ──┐                           │   │
│  │        ├── 尝试 Akshare   ──→ 失败 ──┤                           │   │
│  │        ├── 尝试 Tushare   ──→ 成功 ──┼──→ 返回 DataFrame         │   │
│  │        └── ...（自动故障切换）        │                           │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Step 2: 保存到数据库                                             │   │
│  │                                                                  │   │
│  │   DatabaseManager.save_daily_data(df, code, source_name)         │   │
│  │        │                                                         │   │
│  │        └── 写入 SQLite stock_daily 表（UPSERT 逻辑）             │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Step 3: 获取实时行情                                             │   │
│  │                                                                  │   │
│  │   DataFetcherManager.get_realtime_quote(code)                    │   │
│  │        │                                                         │   │
│  │        └── 获取: 现价、量比、换手率、PE、PB、市值等               │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Step 4: 技术分析                                                 │   │
│  │                                                                  │   │
│  │   StockTrendAnalyzer.analyze(df, code)                           │   │
│  │        │                                                         │   │
│  │        ├── 均线分析: MA5 > MA10 > MA20 多头判断                  │   │
│  │        ├── 乖离率: 不追高策略                                     │   │
│  │        ├── MACD: 金叉/死叉/零轴穿越                              │   │
│  │        ├── RSI: 超买/超卖判断                                     │   │
│  │        └── 量能分析: 缩量回调优先                                 │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Step 5: 新闻情报搜索                                             │   │
│  │                                                                  │   │
│  │   SearchService.search_comprehensive_intel(code, name)           │   │
│  │        │                                                         │   │
│  │        ├── 最新动态搜索                                          │   │
│  │        ├── 风险排查搜索                                          │   │
│  │        └── 业绩预期搜索                                          │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Step 6: AI 综合分析                                              │   │
│  │                                                                  │   │
│  │   GeminiAnalyzer.analyze(context, news_context)                  │   │
│  │        │                                                         │   │
│  │        ├── 组装 Prompt（技术面 + 消息面 + 交易理念）              │   │
│  │        ├── 调用 Gemini / OpenAI API                              │   │
│  │        └── 解析返回结果 → AnalysisResult                         │   │
│  │                                                                  │   │
│  │   返回: 情绪评分、操作建议、趋势预测、分析摘要                    │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Step 7: 推送通知                                                 │   │
│  │                                                                  │   │
│  │   NotificationService.send(report)                               │   │
│  │        │                                                         │   │
│  │        └── 推送到配置的各个渠道（企微/飞书/TG/邮件...）          │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 3.2 WebUI 分析任务流程

```
用户在 WebUI 输入股票代码
         │
         ▼
GET /analysis?code=600519
         │
         ▼
AnalysisService.submit_analysis(code)
         │
         ├── 生成 task_id
         ├── 存入内存 self._tasks[task_id] = {...}  ⚠️ 非持久化
         └── 提交到 ThreadPoolExecutor
                    │
                    ▼
              异步执行分析
                    │
                    ├── 更新 self._tasks[task_id]["status"] = "running"
                    ├── 执行 pipeline.process_single_stock()
                    └── 更新 self._tasks[task_id]["status"] = "completed"
                    
         │
         ▼
前端轮询 GET /task?id=xxx
         │
         ▼
返回任务状态和结果
```

---

## 四、数据库分析

### 4.1 当前数据库使用情况

**你的判断是正确的！** 当前项目的数据库使用非常有限：

| 类型 | 存储方式 | 说明 |
|------|----------|------|
| **股票日线数据** | SQLite 持久化 | `stock_daily` 表，唯一使用的表 |
| **WebUI 任务状态** | ⚠️ **内存字典** | `self._tasks: Dict`，重启即丢失 |
| **用户数据** | ❌ 不存在 | 无用户系统 |
| **会员/订单** | ❌ 不存在 | 无支付系统 |
| **分析历史** | ❌ 不存在 | 分析结果不持久化 |

### 4.2 现有数据库表

**只有一张表：`stock_daily`**

```sql
CREATE TABLE stock_daily (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(10) NOT NULL,       -- 股票代码
    date DATE NOT NULL,              -- 交易日期
    open FLOAT,                      -- 开盘价
    high FLOAT,                      -- 最高价
    low FLOAT,                       -- 最低价
    close FLOAT,                     -- 收盘价
    volume FLOAT,                    -- 成交量
    amount FLOAT,                    -- 成交额
    pct_chg FLOAT,                   -- 涨跌幅
    ma5 FLOAT,                       -- 5日均线
    ma10 FLOAT,                      -- 10日均线
    ma20 FLOAT,                      -- 20日均线
    volume_ratio FLOAT,              -- 量比
    data_source VARCHAR(50),         -- 数据来源
    created_at DATETIME,
    updated_at DATETIME,
    
    UNIQUE(code, date)               -- 唯一约束
);
```

### 4.3 数据库用途分析

```
┌─────────────────────────────────────────────────────────────────────┐
│                    当前数据库用途                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  stock_daily 表的作用：                                             │
│                                                                     │
│  1. 断点续传：                                                       │
│     ├── has_today_data(code) 检查今日数据是否存在                    │
│     └── 如果存在，跳过网络请求，节省 API 调用                         │
│                                                                     │
│  2. 历史数据缓存：                                                   │
│     ├── 保存最近 30 天的日线数据                                     │
│     └── 供技术分析使用（均线、MACD、RSI 计算）                        │
│                                                                     │
│  3. 分析上下文：                                                     │
│     ├── get_analysis_context(code) 获取今日+昨日数据                 │
│     └── 计算涨跌幅、量能变化等                                       │
│                                                                     │
│  ⚠️ 不存储的数据：                                                   │
│     ├── 用户信息                                                     │
│     ├── 分析任务状态（存内存）                                        │
│     ├── 分析结果历史                                                  │
│     ├── 订单/支付记录                                                 │
│     └── 用户配置                                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.4 内存存储的数据

**⚠️ 重要发现：WebUI 任务数据存在内存中！**

```python
# web/services.py - AnalysisService
class AnalysisService:
    def __init__(self):
        self._tasks: Dict[str, Dict[str, Any]] = {}  # 内存字典！
        self._tasks_lock = threading.Lock()
```

**影响**：
- 服务重启后，所有任务记录丢失
- 无法查询历史分析记录
- 无法统计用户使用量

---

## 五、现有功能清单

### 5.1 核心分析功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 个股技术分析 | ✅ | MA/MACD/RSI/量能分析 |
| AI 智能研判 | ✅ | Gemini/OpenAI 综合分析 |
| 新闻情报搜索 | ✅ | Bocha/Tavily/SerpAPI |
| 大盘复盘 | ✅ | 指数分析 + 板块热点 |
| 筹码分布分析 | ✅ | 获利比例/集中度 |
| 支持 A股/港股/美股 | ✅ | 多市场覆盖 |

### 5.2 交互方式

| 方式 | 状态 | 说明 |
|------|------|------|
| 命令行 | ✅ | `python main.py --stocks 600519` |
| WebUI | ✅ | 浏览器访问 http://localhost:8000 |
| 飞书机器人 | ✅ | Stream 模式 / Webhook 模式 |
| 钉钉机器人 | ✅ | Stream 模式 / Webhook 模式 |
| Discord 机器人 | ✅ | 斜杠命令 |
| 定时任务 | ✅ | 每日定时执行 |
| GitHub Actions | ✅ | 云端定时运行 |

### 5.3 通知推送

| 渠道 | 状态 | 说明 |
|------|------|------|
| 企业微信 | ✅ | Webhook 推送 |
| 飞书 | ✅ | Webhook + 云文档 |
| Telegram | ✅ | Bot 推送 |
| Discord | ✅ | Webhook + Bot |
| 邮件 | ✅ | SMTP 自动识别 |
| PushPlus | ✅ | 微信公众号推送 |
| Pushover | ✅ | 手机/桌面推送 |
| 自定义 Webhook | ✅ | 任意 REST API |

---

## 六、功能扩展建议

### 6.1 数据库扩展（必要）

当前数据库利用率极低，建议扩展以下表：

```sql
-- 1. 用户表（鉴权基础）
CREATE TABLE users (...);

-- 2. 分析任务表（持久化任务）
CREATE TABLE analysis_tasks (
    id INTEGER PRIMARY KEY,
    task_id VARCHAR(50) UNIQUE,
    user_id INTEGER,           -- 关联用户
    code VARCHAR(10),
    status VARCHAR(20),        -- pending/running/completed/failed
    result TEXT,               -- JSON 格式的分析结果
    created_at DATETIME,
    completed_at DATETIME
);

-- 3. 分析历史表（积累用户数据）
CREATE TABLE analysis_history (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    code VARCHAR(10),
    sentiment_score INTEGER,
    operation_advice VARCHAR(50),
    analyzed_at DATETIME
);

-- 4. 用户股票池（个性化自选）
CREATE TABLE user_watchlists (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    code VARCHAR(10),
    added_at DATETIME
);
```

### 6.2 会员充值扩展功能

基于会员系统，可以扩展以下增值功能：

| 功能 | 免费用户 | 付费会员 | 说明 |
|------|----------|----------|------|
| 每日分析次数 | 5次 | 50-不限 | 限制 API 调用 |
| 报告类型 | 精简版 | 完整版 | 完整版含更多细节 |
| 实时行情推送 | ❌ | ✅ | 盘中实时提醒 |
| 历史分析查询 | 7天 | 90天 | 查看历史记录 |
| 自选股数量 | 10只 | 100只 | 股票池限制 |
| 批量分析 | ❌ | ✅ | 一键分析所有自选 |
| 定制化报告 | ❌ | ✅ | 自定义报告模板 |
| 邮件日报 | ❌ | ✅ | 每日定时推送 |
| API 调用 | ❌ | ✅ | 开放 API 接口 |
| 优先响应 | ❌ | ✅ | 队列优先处理 |

### 6.3 建议新增的功能模块

#### A. 用户系统相关

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 手机号登录 | 高 | 短信/邮箱验证码 |
| 用户个人中心 | 高 | 查看分析历史、修改设置 |
| 个人股票池 | 高 | 每个用户独立的自选股 |
| 分析历史记录 | 中 | 查看历史分析结果 |
| 操作日志 | 低 | 记录用户行为 |

#### B. 付费增值功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 微信支付 | 高 | Native 支付（扫码） |
| 会员套餐 | 高 | 周/月/季卡 |
| 邀请返利 | 中 | 邀请好友返现 |
| 积分系统 | 低 | 签到得积分 |
| 优惠券 | 低 | 新用户/节日优惠 |

#### C. 分析增强功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 股票对比分析 | 中 | 多只股票横向对比 |
| 行业板块分析 | 中 | 板块轮动跟踪 |
| 资金流向分析 | 中 | 主力资金监控 |
| 龙虎榜分析 | 低 | 游资动向追踪 |
| 智能选股 | 低 | 基于条件筛选 |
| 模拟交易 | 低 | 虚拟盘验证策略 |

#### D. 推送增强

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 用户邮箱推送 | 高 | 用户自定义邮箱 |
| 微信服务号推送 | 中 | 关注公众号推送 |
| 异动提醒 | 中 | 涨停/跌停/放量提醒 |
| 自定义推送时间 | 低 | 用户选择推送时间 |

### 6.4 技术债务清理

| 问题 | 建议 |
|------|------|
| 任务存内存 | 迁移到数据库持久化 |
| 无用户系统 | 新增用户表和鉴权 |
| 无请求鉴权 | 添加中间件拦截 |
| 无使用量统计 | 新增 daily_usage 表 |
| 配置散落 | 整理到统一配置中心 |

---

## 附录：配置项清单

### 当前主要配置（.env）

```env
# 股票池
STOCK_LIST=600519,000001,300750

# AI 分析
GEMINI_API_KEY=xxx
OPENAI_API_KEY=xxx

# 数据源
TUSHARE_TOKEN=xxx

# 搜索引擎
BOCHA_API_KEYS=xxx
TAVILY_API_KEYS=xxx

# 通知渠道
WECHAT_WEBHOOK_URL=xxx
FEISHU_WEBHOOK_URL=xxx
TELEGRAM_BOT_TOKEN=xxx
EMAIL_SENDER=xxx

# WebUI
WEBUI_ENABLED=true
WEBUI_HOST=127.0.0.1
WEBUI_PORT=8000

# 数据库
DATABASE_PATH=./data/stock_analysis.db
```

---

> **总结**：项目架构清晰，核心功能完善，但数据库利用率低，任务数据不持久化。建议先完善数据库设计，再逐步添加用户系统和付费功能。
